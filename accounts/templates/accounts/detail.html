{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
  <div class="container">
    <h1>프로필 페이지</h1>
    <!-- 프로필 이미지 -->
    <div>
      {% if user.profile_image %}
        <img src="{{ user.profile_image.url }}" alt="">
      {% endif %}
    </div>
    <p>{{ user.username }}</p>
    <!-- 프로필 편집 / 팔로우 -->
    <div>
      {% if request.user == user %}
        <a href="{% url 'accounts:update' user.pk %}" class="btn btn-primary">프로필 수정</a>
      {% else %}
        <form id="follow-form" data-user-id='{{ user.pk }}'>
          {% csrf_token %}
          {% if request.user in user.followers.all %}
            <input type="submit" class="btn btn-primary" value="언팔로우">
          {% else %}
            <input type="submit" class="btn btn-primary" value="팔로우">
          {% endif %}
        </form>
      {% endif %}
    </div>

    <!-- 팔로워 박스 누르면 팔로워 목록 모달로 이동 -->
    <div>
      <div class="me-5" style="font-size: 20px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#exampleModal">팔로워
        <b id="followers-count">{{ user.followers.all|length }}</b>
      </div>
      <div style="font-size: 20px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#exampleModal2">팔로잉
        <b id="followings-count">{{ user.followings.all|length }}</b>
      </div>
    </div>

    <!-- 반려동물 목록 -->
    <div>
      {% for user_pet in user_pets %}
        <p>{{ user_pet.petname }}</p>
      {% endfor %}
      <a href="{% url 'accounts:pet_register' user.pk %}">반려동물 등록</a>
    </div>
  </div>

  <!-- 팔로워 리스트 모달 -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">팔로워</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-column">
          {% for follower in user_followers %}
            <div class="my-1">
              <a href="{% url 'accounts:detail' follower.pk %}">
                <span class="ms-2" style="color: black;">{{ follower.username }}</span></a>
            </div>
            {% empty %}
            <p>아직 팔로워가 없어요</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- 팔로잉 리스트 모달 -->
  <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModal2Label" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModal2Label">팔로잉</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-column">
          {% for following in user_followings %}
            <div class="my-1">
              <a href="{% url 'accounts:detail' following.pk %}"></a>
            </div>
            {% empty %}
            <p>아직 팔로잉하는 회원이 없어요</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- 팔로우/팔로우취소 비동기 처리 -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const form = document.querySelector('#follow-form')
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value

      form
      .addEventListener('submit', function (event) {
        event.preventDefault()
        const userId = event
          .target
          .dataset
          .userId

          axios({
            method: 'post',
            url: `/accounts/${userId}/follow/`,
            headers: {
              'X-CSRFToken': csrftoken
            }
          })
          .then((response) => {
            const isFollowed = response.data.is_followed
            const followBtn = document.querySelector('#follow-form > input[type=submit]')
            if (isFollowed === true) {
              followBtn.value = '팔로우 취소'
              followBtn
                .classList
                .add('btn2')
            } else {
              followBtn.value = '팔로우'
              followBtn
                .classList
                .add('btn')
              followBtn
                .classList
                .remove('btn2')
            }
            const followersCountTag = document.querySelector('#followers-count')
            const followingsCountTag = document.querySelector('#followings-count')
            const followersCount = response.data.followers_count
            const followingsCount = response.data.followings_count
            followersCountTag.innerText = followersCount
            followingsCountTag.innerText = followingsCount
          })
          .catch((error) => {
            console.log(error.response)
          })
        });
  </script>
{% endblock content %}
