{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block content %}
  <div class="container">
    <h1>프로필 페이지</h1>
    <!-- 프로필 이미지 -->
    <div>
      {% if user.profile_image %}
        <img src="{{ user.profile_image.url }}" alt="" style="width: 50px; height: 50px; border-radius: 500px">
      {% endif %}
      <span>{{ user.username }}</span>
    </div>
    <!-- 프로필 편집 / 팔로우 / 차단 -->
    <div>
      {% if request.user == user %}
        <div>
          <a href="{% url 'accounts:update' user.pk %}" class="btn btn-primary">프로필 수정</a>
          <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal3">차단 회원 목록</a>
        </div>
        <!-- 등록한 반려동물이 있으면 일기 작성 가능 - 코드 수정 -->
        <div>
          <!-- 일기 작성 버튼 -->
          <a href="{% url 'journal:journal_list' %}" class="btn btn-success">일기 목록</a>
          <a href="{% url 'journal:daily_create' %}" class="btn btn-success">일기 작성하기</a>
          <a href="{% url 'journal:dwj_create' %}" class="btn btn-success">산책일기 작성하기</a>
          <a href="{% url 'journal:health_create' %}" class="btn btn-success">건강일기 작성하기</a>
        </div>
        <div>
          <!-- 회원 탈퇴 -->
          <a href="{% url 'accounts:delete' %}" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#staticBackdrop">탈퇴하기</a>
          <!-- Modal -->
          <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="staticBackdropLabel">회원탈퇴</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  정말 탈퇴하시겠습니까?
                </div>
                <div class="modal-footer">
                  <a href="{% url 'accounts:delete' %}" type="button" class="btn btn-danger">탈퇴</a>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <form id="follow-form" data-user-id='{{ user.pk }}'>
          {% csrf_token %}
          {% if request.user in user.followers.all %}
            <input type="submit" class="btn btn-primary" value="언팔로우">
          {% else %}
            <input type="submit" class="btn btn-primary" value="팔로우">
          {% endif %}
        </form>
        <a href="{% url 'accounts:block' user.pk %}">
          {% if request.user in user.blockers.all %}
            <input type="submit" class="btn btn-danger" value="차단 해제">
          {% else %}
            <input type="submit" class="btn btn-danger" value="차단">
          {% endif %}
        </a>
      {% endif %}
    </div>

    <!-- 팔로워 박스 누르면 팔로워 목록 모달로 이동 -->
    <div>
      <div class="me-5" style="font-size: 20px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#exampleModal">팔로워
        <b id="followers-count">{{ user.followers.all|length }}</b>
      </div>
      <div style="font-size: 20px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#exampleModal2">팔로잉
        <b id="followings-count">{{ user.followings.all|length }}</b>
      </div>
    </div>

    <!-- 반려동물 목록 -->
    <div>
      {% for user_pet in user_pets %}
        <a href="{% url 'accounts:pet_detail' user.pk user_pet.pk %}">
          {% if user_pet.pet_image %}
            <img src="{{ user_pet.pet_image.url }}" alt="" style="width: 50px; height: 50px; border-radius: 500px">
          {% endif %}
          <span>{{ user_pet.petname }}</span>
        </a>
      {% endfor %}
      <div>
        <a href="{% url 'accounts:pet_register' user.pk %}" class="btn btn-primary">반려동물 등록</a>
      </div>
    </div>

    <!-- 지도 -->
    <div>
      <a href="{% url 'information:index' %}" class="btn btn-primary">내 주변 친구 찾기</a>
    </div>

    <!-- 모달 -->
    <!-- 팔로워 리스트 모달 -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">팔로워</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex flex-column">
            {% for follower in user_followers %}
              {% if follower.profile_image %}
                <img src="{{ follower.profile_image.url }}" alt="">
              {% endif %}
              <div class="my-1">
                <a href="{% url 'accounts:detail' follower.pk %}">
                  <span class="ms-2" style="color: black;">{{ follower.username }}</span></a>
              </div>
              {% empty %}
              <p>아직 팔로워가 없어요</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- 팔로잉 리스트 모달 -->
    <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModal2Label" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModal2Label">팔로잉</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex flex-column">
            {% for following in user_followings %}
              {% if following.profile_image %}
                <img src="{{ following.profile_image.url }}" alt="">
              {% endif %}
              <div class="my-1">
                <a href="{% url 'accounts:detail' following.pk %}">{{ following.username }}</a>
              </div>
              {% empty %}
              <p>아직 팔로잉하는 회원이 없어요</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- 차단 회원 목록 모달 -->
    <div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">차단 회원</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex flex-column">
            {% for block in user_blocks %}
              {% if block.profile_image %}
                <img src="{{ block.profile_image.url }}" alt="">
              {% endif %}
              <div class="my-1">
                <a href="{% url 'accounts:detail' block.pk %}">
                  <span class="ms-2" style="color: black;">{{ block.username }}</span></a>
              </div>
              {% empty %}
              <p>아직 차단 회원이 없어요</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- JS -->
    <!-- 팔로우/팔로우취소 비동기 처리 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      const form = document.querySelector('#follow-form')
      const csrftoken = document
        .querySelector('[name=csrfmiddlewaretoken]')
        .value

        form
        .addEventListener('submit', function (event) {
          event.preventDefault()
          const userId = event
            .target
            .dataset
            .userId

            axios({
              method: 'post',
              url: `/accounts/${userId}/follow/`,
              headers: {
                'X-CSRFToken': csrftoken
              }
            })
            .then((response) => {
              const isFollowed = response.data.is_followed
              const followBtn = document.querySelector('#follow-form > input[type=submit]')
              if (isFollowed === true) {
                followBtn.value = '팔로우 취소'
                followBtn
                  .classList
                  .add('btn2')
              } else {
                followBtn.value = '팔로우'
                followBtn
                  .classList
                  .add('btn')
                followBtn
                  .classList
                  .remove('btn2')
              }
              const followersCountTag = document.querySelector('#followers-count')
              const followingsCountTag = document.querySelector('#followings-count')
              const followersCount = response.data.followers_count
              const followingsCount = response.data.followings_count
              followersCountTag.innerText = followersCount
              followingsCountTag.innerText = followingsCount
            })
            .catch((error) => {
              console.log(error.response)
            })
          });
    </script>

    <script>
      var check1 = $("input[id='check1']");
      check1.click(function () {
        $("p").toggle();
      });
      var check2 = $("input[id='check2']");
      check2.click(function () {
        $("h6").toggle();
      });
      const form = document.querySelector('#form-1')
      const csrftoken = document
        .querySelector('[name=csrfmiddlewaretoken]')
        .value
        form
        .addEventListener('submit', function (event) {
          event.preventDefault();
          const p = document.querySelectorAll('p')
          const h6 = document.querySelectorAll('h6')
          for (let i = 0; i < 2; i++) {
            if (p[i].style.display !== 'none') {
              var realp = p[i].innerText
            }
            if (h6[i].style.display !== 'none') {
              var realh6 = h6[i].innerText
            }
          }
          axios({
            method: 'post',
            url: '/accounts/save/',
            headers: {
              'X-CSRFToken': csrftoken
            },
            params: {
              'p': realp,
              'h6': realh6
            }
          }).then(response => {
            location.reload()
          })
        })
    </script>
  {% endblock content %}
